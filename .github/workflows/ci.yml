name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "22"
  CACHE_VERSION: "v1"

jobs:
  # -------------------------------
  # Job 1: TypeScript Type Check
  # -------------------------------
  typescript:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install Dependencies
        env:
          HUSKY: 0
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: TypeScript Type Check
        run: pnpm run type-check

  # -------------------------------
  # Job 2: ESLint
  # -------------------------------
  eslint:
    name: ESLint Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install Dependencies
        env:
          HUSKY: 0
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: ESLint
        run: pnpm run lint

  # -------------------------------
  # Job 3: Prettier
  # -------------------------------
  prettier:
    name: Prettier Formatting
    runs-on: ubuntu-latest
    timeout-minutes: 5

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install Dependencies
        env:
          HUSKY: 0
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Prettier
        run: pnpm run format:check

  # -------------------------------
  # Job 4: Security Audit
  # -------------------------------
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install Dependencies
        env:
          HUSKY: 0
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Security Audit
        run: pnpm audit --audit-level=moderate

  # -------------------------------
  # Job 5: PR Comment Bot
  # -------------------------------
  pr-comment:
    name: PR Status Comment
    runs-on: ubuntu-latest
    needs: [typescript, eslint, prettier, security]
    if: github.event_name == 'pull_request'

    permissions:
      pull-requests: write

    steps:
      - name: Update PR with CI Results
        uses: actions/github-script@v8
        with:
          script: |
            const checks = [
              { name: "TypeScript", status: "${{ needs.typescript.result }}" },
              { name: "ESLint", status: "${{ needs.eslint.result }}" },
              { name: "Prettier", status: "${{ needs.prettier.result }}" },
              { name: "Security Audit", status: "${{ needs.security.result }}" },
            ];

            const iconMap = {
              success: "âœ… Passed",
              failure: "âŒ Failed",
              cancelled: "ðŸš« Cancelled",
              skipped: "â­ï¸ Skipped",
            };

            const icon = (s) => iconMap[s] || "â³ Running";

            const body = `##  CI Results

            ${checks.map(c => `- **${c.name}**: ${icon(c.status)}`).join("\n")}

            ---
            **Commit**: \`${{ github.sha }}\`
            **Branch**: \`${{ github.head_ref }}\`
            **Author**: @${{ github.actor }}
            `;

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            // Fetch existing comments
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
            });

            // Find existing CI comment
            const existing = comments.find(
              (comment) =>
                comment.user.type === "Bot" &&
                comment.body.includes("##  CI Results")
            );

            if (existing) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body: body + "\n\nðŸ“Œ _This comment is auto-updated_",
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
